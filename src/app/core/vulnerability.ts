import { DEFAULT_WEIGHTS, GENDER_WEIGHTS } from './datasets';


export interface GenderData {
  dones: number;
  homes: number;
  total: number;
  brecha_percentual?: number; 
}


export interface BarriData {
  id: string;
  nom: string;
  districte: string;
  
  
  poblacio: number;
  poblacio_per_sexe: GenderData;
  
  // Renta desagregada por sexo
  renda_mitjana: number;
  renda_per_sexe: {
    dones: number;
    homes: number;
    brecha_percentual: number; 
  };
  
  // Desempleo desagregado por sexo
  atur: number;
  atur_per_sexe: {
    dones: number;
    homes: number;
    diferencia_puntos: number; 
  };

 
  envelliment: number;
  immigracio: number;
  
 
  index_desigualdad_genero?: number; 
}

export interface BarriVulnerability extends BarriData {
  vulnerability_score: number;
  
 
  renda_normalized: number;
  atur_normalized: number;
  envelliment_normalized: number;
  immigracio_normalized: number;
  
  
  brecha_salarial_normalized: number;
  brecha_empleo_normalized: number;
  
  rank: number;
  rank_genero?: number; 
}


export interface Weights {
  renda: number;
  atur: number;
  envelliment: number;
  immigracio: number;
  
  brecha_genero?: number;
}


function normalize(value: number, min: number, max: number, inverse = false): number {
  if (max === min) return 0.5;
  const normalized = (value - min) / (max - min);
  return inverse ? 1 - normalized : normalized;
}


function calculateGenderInequalityIndex(barri: BarriData): number {
  const brecha_salarial_norm = barri.renda_per_sexe.brecha_percentual / 100;
  const brecha_empleo_norm = Math.abs(barri.atur_per_sexe.diferencia_puntos) / 20; // Asumiendo max 20 puntos
  
  
  return (brecha_salarial_norm * 0.6 + brecha_empleo_norm * 0.4);
}


export function calculateVulnerability(
  barris: BarriData[],
  weights: Weights = DEFAULT_WEIGHTS,
  includeGender: boolean = false
): BarriVulnerability[] {
  
  
  const totalWeight = Object.values(weights).reduce((sum, w) => sum + w, 0);
  
  if (Math.abs(totalWeight - 1) > 0.001) {
    console.warn(`Els pesos no sumen 1 (${totalWeight}). Normalitzant...`);
    const factor = 1 / totalWeight;
    weights = {
      renda: weights.renda * factor,
      atur: weights.atur * factor,
      envelliment: weights.envelliment * factor,
      immigracio: weights.immigracio * factor,
      brecha_genero: weights.brecha_genero ? weights.brecha_genero * factor : undefined
    };
  }

  
  const stats = {
    renda: { min: Infinity, max: -Infinity },
    atur: { min: Infinity, max: -Infinity },
    envelliment: { min: Infinity, max: -Infinity },
    immigracio: { min: Infinity, max: -Infinity },
    
    brecha_salarial: { min: Infinity, max: -Infinity },
    brecha_empleo: { min: Infinity, max: -Infinity }
  };

  barris.forEach(barri => {
    
    stats.renda.min = Math.min(stats.renda.min, barri.renda_mitjana);
    stats.renda.max = Math.max(stats.renda.max, barri.renda_mitjana);
    stats.atur.min = Math.min(stats.atur.min, barri.atur);
    stats.atur.max = Math.max(stats.atur.max, barri.atur);
    stats.envelliment.min = Math.min(stats.envelliment.min, barri.envelliment);
    stats.envelliment.max = Math.max(stats.envelliment.max, barri.envelliment);
    stats.immigracio.min = Math.min(stats.immigracio.min, barri.immigracio);
    stats.immigracio.max = Math.max(stats.immigracio.max, barri.immigracio);
    
    
    stats.brecha_salarial.min = Math.min(stats.brecha_salarial.min, barri.renda_per_sexe.brecha_percentual);
    stats.brecha_salarial.max = Math.max(stats.brecha_salarial.max, barri.renda_per_sexe.brecha_percentual);
    stats.brecha_empleo.min = Math.min(stats.brecha_empleo.min, Math.abs(barri.atur_per_sexe.diferencia_puntos));
    stats.brecha_empleo.max = Math.max(stats.brecha_empleo.max, Math.abs(barri.atur_per_sexe.diferencia_puntos));
  });

  
  const result: BarriVulnerability[] = barris.map(barri => {
    
    const renda_norm = normalize(barri.renda_mitjana, stats.renda.min, stats.renda.max, true);
    
    
    const atur_norm = normalize(barri.atur, stats.atur.min, stats.atur.max, false);
    
    
    const envelliment_norm = normalize(barri.envelliment, stats.envelliment.min, stats.envelliment.max, false);
    
    const immigracio_norm = normalize(barri.immigracio, stats.immigracio.min, stats.immigracio.max, false);
    
   
    const brecha_salarial_norm = normalize(
      barri.renda_per_sexe.brecha_percentual, 
      stats.brecha_salarial.min, 
      stats.brecha_salarial.max, 
      false 
    );
    
    const brecha_empleo_norm = normalize(
      Math.abs(barri.atur_per_sexe.diferencia_puntos), 
      stats.brecha_empleo.min, 
      stats.brecha_empleo.max, 
      false 
    );

    
    let vulnerability_score: number;
    
    if (includeGender && weights.brecha_genero) {
      
      const gender_index = (brecha_salarial_norm + brecha_empleo_norm) / 2;
      
      vulnerability_score = 
        renda_norm * weights.renda +
        atur_norm * weights.atur +
        envelliment_norm * weights.envelliment +
        immigracio_norm * weights.immigracio +
        gender_index * weights.brecha_genero;
    } else {
      
      vulnerability_score = 
        renda_norm * weights.renda +
        atur_norm * weights.atur +
        envelliment_norm * weights.envelliment +
        immigracio_norm * weights.immigracio;
    }

   
    const index_desigualdad_genero = calculateGenderInequalityIndex(barri);

    return {
      ...barri,
      vulnerability_score,
      renda_normalized: renda_norm,
      atur_normalized: atur_norm,
      envelliment_normalized: envelliment_norm,
      immigracio_normalized: immigracio_norm,
      brecha_salarial_normalized: brecha_salarial_norm,
      brecha_empleo_normalized: brecha_empleo_norm,
      index_desigualdad_genero,
      rank: 0, 
      rank_genero: 0 
    };
  });

 
  result.sort((a, b) => b.vulnerability_score - a.vulnerability_score);
  result.forEach((barri, index) => {
    barri.rank = index + 1;
  });

  
  const sortedByGender = [...result].sort((a, b) => 
    (b.index_desigualdad_genero || 0) - (a.index_desigualdad_genero || 0)
  );
  sortedByGender.forEach((barri, index) => {
    const originalBarri = result.find(b => b.id === barri.id);
    if (originalBarri) {
      originalBarri.rank_genero = index + 1;
    }
  });

  return result;
}

export function getVulnerabilityStats(barris: BarriVulnerability[]) {
  const scores = barris.map(b => b.vulnerability_score);
  const mean = scores.reduce((sum, s) => sum + s, 0) / scores.length;
  const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
  const stdDev = Math.sqrt(variance);

  return {
    mean,
    stdDev,
    min: Math.min(...scores),
    max: Math.max(...scores),
    median: scores.sort((a, b) => a - b)[Math.floor(scores.length / 2)]
  };
}


export function getGenderInequalityStats(barris: BarriVulnerability[]) {
  const brechas_salariales = barris.map(b => b.renda_per_sexe.brecha_percentual);
  const brechas_empleo = barris.map(b => Math.abs(b.atur_per_sexe.diferencia_puntos));
  const indices_genero = barris.map(b => b.index_desigualdad_genero || 0);

  return {
    brecha_salarial: {
      media: brechas_salariales.reduce((sum, b) => sum + b, 0) / brechas_salariales.length,
      min: Math.min(...brechas_salariales),
      max: Math.max(...brechas_salariales),
      barrios_mayor_brecha: barris
        .sort((a, b) => b.renda_per_sexe.brecha_percentual - a.renda_per_sexe.brecha_percentual)
        .slice(0, 5)
        .map(b => ({ nom: b.nom, brecha: b.renda_per_sexe.brecha_percentual }))
    },
    brecha_empleo: {
      media: brechas_empleo.reduce((sum, b) => sum + b, 0) / brechas_empleo.length,
      min: Math.min(...brechas_empleo),
      max: Math.max(...brechas_empleo),
      barrios_mayor_diferencia: barris
        .sort((a, b) => Math.abs(b.atur_per_sexe.diferencia_puntos) - Math.abs(a.atur_per_sexe.diferencia_puntos))
        .slice(0, 5)
        .map(b => ({ nom: b.nom, diferencia: b.atur_per_sexe.diferencia_puntos }))
    },
    indice_desigualdad: {
      media: indices_genero.reduce((sum, i) => sum + i, 0) / indices_genero.length,
      min: Math.min(...indices_genero),
      max: Math.max(...indices_genero)
    }
  };
}


export function classifyGenderInequality(index: number): 'baixa' | 'mitjana' | 'alta' {
  if (index < 0.3) return 'baixa';
  if (index < 0.6) return 'mitjana';
  return 'alta';
}
/* 

import { DEFAULT_WEIGHTS } from './datasets';

export interface BarriData {
  id: string;
  nom: string;
  districte: string;
  poblacio: number;
  renda_mitjana: number;
  atur: number;
  envelliment: number;
  immigracio: number;
}

export interface BarriVulnerability extends BarriData {
  vulnerability_score: number;
  renda_normalized: number;
  atur_normalized: number;
  envelliment_normalized: number;
  immigracio_normalized: number;
  rank: number;
}

export interface Weights {
  renda: number;
  atur: number;
  envelliment: number;
  immigracio: number;
}

function normalize(value: number, min: number, max: number, inverse = false): number {
  if (max === min) return 0.5;
  const normalized = (value - min) / (max - min);
  return inverse ? 1 - normalized : normalized;
}


 * @param barris 
 * @param weights  
 * @returns

export function calculateVulnerability(
  barris: BarriData[],
  weights: Weights = DEFAULT_WEIGHTS
): BarriVulnerability[] {

  const totalWeight = Object.values(weights).reduce((sum, w) => sum + w, 0);
  if (Math.abs(totalWeight - 1) > 0.001) {
    console.warn(`Els pesos no sumen 1 (${totalWeight}). Normalitzant...`);
    const factor = 1 / totalWeight;
    weights = {
      renda: weights.renda * factor,
      atur: weights.atur * factor,
      envelliment: weights.envelliment * factor,
      immigracio: weights.immigracio * factor
    };
  }

 
  const stats = {
    renda: { min: Infinity, max: -Infinity },
    atur: { min: Infinity, max: -Infinity },
    envelliment: { min: Infinity, max: -Infinity },
    immigracio: { min: Infinity, max: -Infinity }
  };

  barris.forEach(barri => {
    stats.renda.min = Math.min(stats.renda.min, barri.renda_mitjana);
    stats.renda.max = Math.max(stats.renda.max, barri.renda_mitjana);
    stats.atur.min = Math.min(stats.atur.min, barri.atur);
    stats.atur.max = Math.max(stats.atur.max, barri.atur);
    stats.envelliment.min = Math.min(stats.envelliment.min, barri.envelliment);
    stats.envelliment.max = Math.max(stats.envelliment.max, barri.envelliment);
    stats.immigracio.min = Math.min(stats.immigracio.min, barri.immigracio);
    stats.immigracio.max = Math.max(stats.immigracio.max, barri.immigracio);
  });

 
  const result: BarriVulnerability[] = barris.map(barri => {
   
    const renda_norm = normalize(barri.renda_mitjana, stats.renda.min, stats.renda.max, true);
   
    const atur_norm = normalize(barri.atur, stats.atur.min, stats.atur.max, false);
   
    const envelliment_norm = normalize(barri.envelliment, stats.envelliment.min, stats.envelliment.max, false);
   
    const immigracio_norm = normalize(barri.immigracio, stats.immigracio.min, stats.immigracio.max, false);

    
    const vulnerability_score = 
      renda_norm * weights.renda +
      atur_norm * weights.atur +
      envelliment_norm * weights.envelliment +
      immigracio_norm * weights.immigracio;

    return {
      ...barri,
      vulnerability_score,
      renda_normalized: renda_norm,
      atur_normalized: atur_norm,
      envelliment_normalized: envelliment_norm,
      immigracio_normalized: immigracio_norm,
      rank: 0 
    };
  });


  result.sort((a, b) => b.vulnerability_score - a.vulnerability_score);
  result.forEach((barri, index) => {
    barri.rank = index + 1;
  });

  return result;
}

export function getVulnerabilityStats(barris: BarriVulnerability[]) {
  const scores = barris.map(b => b.vulnerability_score);
  const mean = scores.reduce((sum, s) => sum + s, 0) / scores.length;
  const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
  const stdDev = Math.sqrt(variance);

  return {
    mean,
    stdDev,
    min: Math.min(...scores),
    max: Math.max(...scores),
    median: scores.sort((a, b) => a - b)[Math.floor(scores.length / 2)]
  };
}
 */